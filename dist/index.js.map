{"version":3,"sources":["index.js"],"names":["server","Server","io","promisifyAll","connect","db","useMongoClient","keepAlive","connection","on","Error","randomVersion","findOne","sort","time","execAsync","then","phancap","_id","toString","console","log","socket","data","findOneAsync","userId","user","indexOf","id","push","broadcast","emit","first","indexstore","Date","getTime","login","length","i","v","updateAsync","$set","last","saveAsync","uId","remove","sk","findIndex","message","from","ObjectID","undefined","toGroup","toUser","content","state","type","forEach","recent","updateRecent","group","member","idsIn","flatMap","m","findAsync","$in","users","rid","ii","receiver","ids","is","r","boxId","unread","month","year","result","username","j","fD","getFullYear","index","k","ur","ar","chunk","del","listen","port"],"mappings":"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","file":"index.js","sourceRoot":".."}