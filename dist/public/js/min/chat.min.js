var ChatApp=function(t,e,a){var n,o="sendmessage",i="chatbox close",s="chatbox update contact",c="call instance",r="chat contact set state",d="/img/male.png",l="socket send message",p="socket get message",f="socket send connect",u="socket get connect",m="socket send read message",h="socket get read message",v="socket get update group",b="socket get remove group",g="socket get update user",x="socket broadcast connect",y="socket broadcast disconnect",D="creat group",k="update group",w="remove group",C="leave group",S="add contact",I="remove contact",O="visitor_chat",T="supporter_chat",q=10,N="chat_user",j="chat_version",G="chat_phancap",E="chat_contact",M="chat_current",U=!0,R="online",B="offline",P=a||"",A=1e7,J=0,V=["(angel)","(bigsmile)","(blush)","(brokenheart)","(call)","($)","(clapping)","(coffee)","(cool)","(crying)","(devil)","(envy)","(evilgrin)","(fubar)","(giggle)","(handshake)","(happy)","(headbang)","(heart)","(hi)","(inlove)","(kiss)","(makeup)","(music)","(no)","(phone)","(rock)","(rofl)","(smile)","(talking)","(thinking)","(wait)","(worried)","(yawn)","(yes)"],H=["angel","bigsmile","blush","brokenheart","call","cash","clapping","coffee","cool","crying","devil","envy","evilgrin","fubar","giggle","handshake","happy","headbang","heart","hi","inlove","kiss","makeup","music","no","phone","rock","rofl","smile","talking","thinking","wait","worried","yawn","yes"],F=t,K=function(t){try{if(!t)return"";var e=new Date,a=parseInt((e-t)/1e3);return a>=31536e3?parseInt(a/31536e3)+" n&#259;m":a>=2592e3?parseInt(a/2592e3)+" th&aacute;ng":a>=86400?parseInt(a/86400)+" ng&agrave;y":a>=3600?parseInt(a/3600)+" gi&#7901;":a>=60?parseInt(a/60)+" ph&uacute;t":parseInt(a)+" gi&acirc;y"}catch(t){return""}},L=function(t){for(var e="",a=function(){var t=Math.floor(62*Math.random());return t<10?t:t<36?String.fromCharCode(t+55):String.fromCharCode(t+61)};e.length<t;)e+=a();return e},X=function(t){t="number"==typeof t?new Date(t):t;var e=["Ch&#7911; nh&#7853;t","Th&#7913; hai","Th&#7913; ba","Th&#7913; t&#432;","Th&#7913; n&#259;m","Th&#7913; s&aacute;u","Th&#7913; b&#7843;y"];return e[t.getDay()]+", ng&agrave;y "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()},z=function(t,e){return t="number"==typeof t?new Date(t):t,e="number"==typeof e?new Date(e):e,t.toDateString()===e.toDateString()},Y=function(t,e){localStorage||(localStorage={}),localStorage[t]=JSON.stringify(e)},Q=function(t){if(localStorage||(localStorage={}),U&&localStorage[t])return JSON.parse(localStorage[t])},W=function(t,e,a,n){var o=new XMLHttpRequest;o.responseType="json",o.open("POST",t),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),o.setRequestHeader("Accept-Language","en-US,en;q=0.5"),o.setRequestHeader("Access-Control-Allow-Origin","*"),o.onload=function(){n(o.response)},o.send(JSON.stringify({query:e,variables:a}))},Z=function(t,e){var a=new XMLHttpRequest;a.responseType="json",a.open("POST","/api/upload",!0),a.upload.onprogress=function(t){if(t.lengthComputable){var e=t.loaded/t.total*100;console.log(e+"% uploaded")}},a.onload=function(){if(200==this.status){JSON.parse(this.response);e(this.response)}},a.send(t)},tt=function(t,e,a){t.action=e;var n={g:t},o="mutation UpdateGroup($g:groupInput){updateGroup(g:$g) {id,member,name,creater}}";W(P+"/graphql",o,n,function(t){t.data.updateGroup?a(t.data.updateGroup):(console.log(t),alert("Khong the tao Nhom luc nay"))})},et=function(t,e,a){t.action=e;var n={u:t},o="mutation UpdateUser($u:userInput){updateUser(u:$u){id,userId,nickName,avatar,friends}}";W(P+"/graphql",o,n,function(t){t.data.updateUser?a(t.data.updateUser):alert("Khong the tao thao tac luc nay")})},at=function(t,e,a,n,o,i,s,c){var r=[];t&&r.push('user(q:"'+t+'"){id,userId,nickName,avatar,friends,recent{id,unread,last,type}}'),e&&r.push('users(q:"'+JSON.stringify({query:{},limit:3e3}).replace(/"/g,'\\"')+'"){id,nickName,last,avatar,last}'),a&&r.push("online"),o&&r.push("phancap{phancap{members {id }, subs {TenDonViCap2, members{id }, subs {TenDonViCap3, members{id }, subs{TenDonViCap4, members{id } } } } } }"),s&&r.push('group(user:"'+t+'"){id,name,member,creater}'),W(P+"/graphql","{"+r.join()+"}",void 0,function(t){c(t.data)})},nt=function(t){return P+t},ot=function(t){return'<img src="'+nt("/img/emoticon/"+t+".gif")+'"/>'},it=function(t){for(var e=$('<div class="line_message"><div class="content_message"></div></div>'),a=0;a<V.length;a++){var n=ot(H[a]),o=t.split(V[a]);t=o.join(n)}if(e.find(".content_message").append(t),""==e.find(".content_message").text().trim()&&e.find(".content_message").css("background-color","white"),e.find("a.fileattach").length>0||e.find("a.filetemp").length>0){e.find(".content_message").css("background-color","white");var i=e.find("a.fileattach").attr("href");e.find("a.fileattach").attr("href",P+i)}return e},st=function(t){W(P+"/graphql",'{userById(q:"'+t+'"){userId}}',{},function(t){var e=t.data.userById.userId;window.open("http://thongtinnoibo.mic.gov.vn/Pages/thongtincanhan.aspx?taikhoan="+e,"name","height=400,width=600")})},ct=Q(E),rt=Q(G),dt=[],lt=[],pt=$("<div id='chatapp' class='chat-app'></div>"),ft=function(t,e){return this.box=t,this.membertemp=[],this.state=e||{show:!0,full:!0,online:!1,new:0,title:""},this.box_head=$('<div class="live-hd"><div class="pull-left visitor-name"></div><div class="pull-right"><a href="javascript:void(0)" class="btnclose-min"><i class="fa fa-chevron-down"></i><i class="fa fa-chevron-up"></i></a><a href="javascript:void(0)"><i class="fa fa-remove"></i></a></div><div class="clearfix"></div></div>'),this.box_content_top=$('<div class="live-ct-top"></div>'),this.btn_add_contact=$('<a href="javascript:void(0)"><i class="fa fa-plus fa-lg"></i></a>'),this.btn_info_contact=$('<a href="javascript:void(0)"><i class="fa fa-info fa-lg"></i></a>'),this.btn_minus_contact=$('<a href="javascript:void(0)"><i class="fa fa-minus fa-lg"></i></a>'),this.btn_leave_group=$('<a href="javascript:void(0)"><i class="fa fa-sign-out fa-lg"></i></a>'),this.btn_remove_group=$('<a href="javascript:void(0)"><i class="fa fa-trash-o fa-lg"></i></a>'),this.box_content_search=$('<div class="live-search"><i class="fa fa-search"></i><input type="text" placeholder="T&igrave;m ki&#7871;m"></div>'),this.box_content_emoticon=$('<div class="live-emoticon"></div>'),this.emoticon_box=$('<div class="emoticon-box"><div class="box-detail"><span class="shortcut"/></div><div class="box-list"></div></div>'),this.box_content_input=$('<div class="live-chat-ft"><div class="textarea"><textarea placeholder="Nh&#7853;p n&#7897;i dung"></textarea></div><button class="btn btn-submit">G&#7917;i</button><a href="javascript:void(0)" class="btn btn-attach" title="&#272;&iacute;nh k&egrave;m file"><i class="fa fa-paperclip fa-lg"></i></a><input type="file" class="fu" style="display:none" name="fileattach" multiple/></div>'),this.box_content=$('<div class="live-ct"></div>'),this.box_content_chat=$('<div class="live-chat"></div>'),this.box_group_add_user=$('<div class="content-adduser"><a href="javascript:void(0)" class="btn-creategroup"><i class="fa fa-check fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-refresh"><i class="fa fa-refresh fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-cancel"><i class="fa fa-close fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-add"><i class="fa fa-group fa-lg"></i></a><div class="content"><div class="select-box"><select class="js-multiple" data-placeholder="Th&ecirc;m th&agrave;nh vi&ecirc;n..." multiple tabindex="3"></select></div></div></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.search_btnRefresh={},this.messages=[],this.messageTemp={},this.dates=[],this._typeEmoticon="",this.setState=function(t){var e=this;e.state=_.assign(e.state,t),e.dom.removeClass("hidden"),0==e.state.show&&e.dom.addClass("hidden"),e.box_content.removeClass("in"),e.box_head.find(".btnclose-min").removeClass("open"),e.state.full&&(e.box_content.addClass("in"),e.box_head.find(".btnclose-min").addClass("open")),e.box_head.find(".online").remove(),e.state.online&&e.box_head.prepend('<span class="online pull-left"></span>')},this.displayMessage=function(t,e,a){var n=this;if(t.idtemp&&(n.messageTemp[e]=t),e&&n.messageTemp[e])return void(n.messageTemp[e].dom=it(t.content));t.time=t.time||new Date-J;var o=X(t.time),i=_.findIndex(n.dates,function(e){return z(e.date,t.time)});if(i==-1){var s=$('<time class="text-right">'+o+"</time>");!_.last(n.dates)||t.time>_.last(n.dates).date?(n.box_content_chat.append(s),n.dates.push({date:t.time,dom:s})):(n.box_content_chat.prepend(s),n.dates.splice(0,0,{date:t.time,dom:s}))}t.dom||("system"===t.from?t.dom=$('<span class="system-notify">'+t.content+"</span>"):t.dom=it(t.content));var c=_.findIndex(n.messages,function(e){return e.time>t.time});if(c==-1){if(_.last(n.messages)&&_.last(n.messages).from==t.from&&i!==-1)_.last(n.messages).dom.after(t.dom);else if(t.from==F.id){var r=$('<div class="'+O+'"></div>');r.append(t.dom),n.box_content_chat.append(r)}else if("system"===t.from)n.box_content_chat.append(t.dom);else{var r=$('<div class="'+T+'"><div class="avatar"><img src="'+(ct[t.from].avatar||d)+'"></div> </div>');r.append(t.dom),n.box_content_chat.append(r)}n.messages.push(t)}else{if(n.messages[c].from===t.from&&i!==-1)n.messages[c].dom.before(t.dom);else if(t.from==F.id){var r=$('<div class="'+O+'"></div>');r.append(t.dom),n.dates[0].dom.after(r)}else if("system"===t.from)n.dates[0].dom.after(t.dom);else{var r=$('<div class="'+T+'"><div class="avatar"><img src="'+(ct[t.from].avatar||d)+'"></div> </div>');r.append(t.dom),n.dates[0].dom.after(r)}n.messages.splice(c,0,t)}a&&n.box_content_chat.scrollTop(1e10)},this.scrollMessage=function(t){},this.createMessage=function(t,e){var a=this;return"group"==a.box.type?{idtemp:e||L(8),from:F.id,toGroup:a.box.id,content:t}:{idtemp:e||L(8),from:F.id,toUser:a.box.id,content:t}},this.loadMessage=function(t){var e=this,a=void 0,n={time:-1};if(t){var o=_.first(e.messages)?_.first(e.messages).time:void 0;a={$lt:o}}if("group"==e.box.type){var i={query:{toGroup:e.box.id},page:0,limit:q};a&&(i.query.time=a),i.sort=n;var s="id, content, time, state, from, toGroup";W(P+"/graphql",'{message(q:"'+JSON.stringify(i).replace(/"/g,'\\"')+'"){'+s+"}}",{},function(a){var n=a.data.message||[];n.forEach(function(a){a.time=parseInt(a.time);var n=!t;e.displayMessage(a,void 0,n)})})}else{var i={query:{$or:[{toUser:F.id,from:e.box.id},{toUser:e.box.id,from:F.id}]},page:0,limit:q};a&&(i.query.time=a),i.sort=n;var s="id, content, time, state, from, toUser";W(P+"/graphql",'{message(q:"'+JSON.stringify(i).replace(/"/g,'\\"')+'"){'+s+"}}",void 0,function(a){var n=a.data.message||[];n.forEach(function(a){a.time=parseInt(a.time);var n=!t;e.displayMessage(a,void 0,n)})})}},this.updateBox=function(t){var e=this;e.box=_.clone(t),e.box_head.find(".visitor-name").html(e.box.title),"group"===t.type&&e.search_btnRefresh.click()},this.loadEmoticonBox=function(t){var e=this;if(e._typeEmoticon!=t&&"base"==t){for(var a=e.emoticon_box.find(".box-list"),n=(e.emoticon_box.find(".box-detail").find("img"),e.emoticon_box.find(".shortcut")),o=0;o<H.length;o++){var i=$('<img src="'+nt("/img/emoticon/"+H[o]+".png")+'" class="emoticon-item"/>');i.hover(function(){var t=$(this).attr("src").split(".")[0].split("/"),a=_.indexOf(H,t[t.length-1]);$(this).css("border","1px solid #3584d1"),e.emoticon_box.find(".box-detail").find("img").remove(),e.emoticon_box.find(".box-detail").prepend(ot(t[t.length-1])),n.html(V[a])},function(){$(this).css("border","none")}),i.click(function(){var t=$(this).attr("src").split(".")[0].split("/"),a=_.indexOf(H,t[t.length-1]),n=e.box_content_input.find("textarea");n.val(n.val()+V[a]),e.emoticon_box.toggle(),n.focus()}),a.append(i)}e._typeEmoticon=t}},this.init=function(){var t=this;if(t.wrap.append(t.box_head),t.box_content.append(t.box_content_top),t.box_content.append(t.box_content_chat),t.box_content.append(t.box_content_emoticon),t.box_content.append(t.box_content_input),"group"===t.box.type){var e=t.box_group_add_user.find(".js-multiple");t.membertemp=_.clone(t.box.member),_.forEach(ct,function(a,n){var o="";t.box.member.indexOf(a.id)!==-1&&(o='selected="true"'),e.append('<option value="'+a.id+'" '+o+">"+a.nickName+"</option>")});var a={disable_search_threshold:10,no_results_text:"Kh&ocirc;ng ph&ugrave; h&#7907;p!",width:"100%"},n=!1;if(t.box.creater&&t.box.creater===F.id){var c=t.box_head.find(".visitor-name");c.dblclick(function(){$(this).attr("contenteditable",!0);var e=$(this).html();$(this).addClass("edit-title"),$(this).keydown(function(a){13==a.which&&(a.preventDefault(),""!==$(this).html().trim()?(tt({id:t.box.id,title:$(this).text().trim()},k,function(t){}),$(this).attr("contenteditable","false"),$(this).removeClass("edit-title")):($(this).html(e),$(this).attr("contenteditable","false"),$(this).removeClass("edit-title")))}),$(this).focus()}),a.allow_single_deselect=!0,n=!0}e.chosen(a),e.chosen().change(function(e,a){a.selected&&t.membertemp.push(a.selected),a.deselected&&_.pull(t.membertemp,a.deselected)});var r=t.box_group_add_user.find(".btn-add"),d=t.box_group_add_user.find(".content"),l=t.box_group_add_user.find(".btn-cancel"),p=t.box_group_add_user.find(".btn-creategroup");t.search_btnRefresh=t.box_group_add_user.find(".btn-refresh"),r.click(function(){d.addClass("view-adduser"),t.box_content_top.find(".ga").fadeIn(1e3).css("display","inline-block")}),l.click(function(){d.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3),t.membertemp=_.clone(t.box.member),e.find("option").each(function(){$(this).removeAttr("selected"),t.box.member.indexOf($(this).val())!==-1&&$(this).prop("selected",!0)}),e.trigger("chosen:updated")}),p.click(function(){d.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3);var e=n?t.membertemp:_.union(t.membertemp,t.box.member);tt({id:t.box.id,member:e},k,function(e){d.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3)})}),t.search_btnRefresh.click(function(){t.membertemp=_.clone(t.box.member),e.find("option").each(function(){$(this).removeAttr("selected"),t.box.member.indexOf($(this).val())!==-1&&$(this).prop("selected",!0)}),e.trigger("chosen:updated")}),t.btn_leave_group.click(function(){t.box.member.splice(_.indexOf(t.box.member,F.id),1),tt({id:t.box.id,member:t.box.member},k,function(e){t.state.show=!1,mt(C,e)})}),t.box_content_top.append(t.btn_leave_group),n&&(t.btn_remove_group.click(function(){tt({id:t.box.id},w,function(t){})}),t.box_content_top.append(t.btn_remove_group)),t.box_content_top.append(t.box_group_add_user)}else t.box.title=ct[t.box.id].nickName,t.btn_info_contact.click(function(){st(t.box.id)}),t.box_content_top.append(t.btn_info_contact),t.btn_minus_contact.click(function(){et({id:F.id,contactId:t.box.id},I,function(e){mt(s,e),t.btn_minus_contact.fadeOut(1e3),t.btn_add_contact.fadeIn(1e3).css("display","inline-block")})}),t.btn_add_contact.click(function(){et({id:F.id,contactId:t.box.id},S,function(e){mt(s,e),t.btn_add_contact.fadeOut(1e3),t.btn_minus_contact.fadeIn(1e3).css("display","inline-block")})}),t.box_content_top.append(t.btn_minus_contact),t.box_content_top.append(t.btn_add_contact),F.friends.indexOf(t.box.id)!==-1?t.btn_add_contact.css("display","none"):t.btn_minus_contact.css("display","none");t.box_head.find(".visitor-name").html(t.box.title),t.wrap.append(t.box_content),t.dom.append(t.wrap),t.setState(),t.box_content_chat.scroll(function(){0===$(this).scrollTop()&&t.loadMessage(!0)});var f=t.box_head.find("a.btnclose-min");f.on("click",function(){0==t.state.full,t.setState(),mt(i)});var u=t.box_head.find("a .fa-remove");u.on("click",function(e){t.state.show=!1,t.setState(),mt(i)});var h=$('<img src="'+nt("/img/emoticon/smile.png")+'" class="emotion-bar" />');h.click(function(){t.loadEmoticonBox("base"),t.emoticon_box.toggle()}),t.box_content_emoticon.append(h),t.box_content_emoticon.append(t.emoticon_box);var v=t.box_content_input.find("textarea");v.keydown(function(e){if(13==e.keyCode&&e.shiftKey){var a=$(this).val();return $(this).val(a+"\n"),void e.stopPropagation()}if(13==e.which&&(e.preventDefault(),""!==$(this).val())){var n=t.createMessage($(this).val());mt(o,n),$(this).val(""),t.displayMessage(n,void 0,!0)}}),v.focus(function(){if(console.log("focux textBox"),F.recent&&F.recent.length>0){var e=_.findIndex(F.recent,{id:t.box.id});e!=-1&&F.recent[e].unread>0&&mt(m,{id:F.id,boxId:t.box.id})}}),v.focus();var b=t.box_content_input.find("button.btn-submit");b.click(function(e){if(e.preventDefault(),""!==v.val()){var a=t.createMessage(v.val());mt(o,a),v.val(""),t.displayMessage(a,void 0,!0)}});var g=t.box_content_input.find('input[type="file"]');g.change(function(){for(var e=this,a=$(e).prop("files"),n=new FormData,o=0,i=0;i<a.length;i++){if(a[i].size<=A){var s=L(8);console.log(s,"----",a[i]),n.append("recfiles",a[i]),n.append("temp",s),o++}else alert("Dung lượng file: "+a[i]+" lớn, không gửi được.");o>0&&(n.append("from",F.id),"group"==t.box.type?n.append("toGroup",t.box.id):n.append("toUser",t.box.id),console.log(n),Z(n,function(){}))}$(e).val("")});var x=t.box_content_input.find(".btn-attach");return x.click(function(t){g.click()}),t.loadMessage(),t},this.init()},ut=function(t,e){return this.state=t||{tab:0,full:!1},this.title=e,this.contactDom={},this.onlineDom={},this.friendDom={},this.recentDom={},this.nhomDom={},this.contact_head=$('<div class="live-hd"><div class="pull-left visitor-name">'+this.title+'</div><div class="pull-right"><a href="javascript:void(0)" class="btn-addgroup"><i class="fa fa-plus"></i></a><a href="javascript:void(0)" class="btnclose-min"><i class="fa fa-chevron-down"></i><i class="fa fa-chevron-up"></i></a></div><div class="clearfix"></div></div>'),this.contact_content=$('<div class="live-ct"></div>'),this.contact_tab_nav=$('<ul class="nav nav-tabs"><li><a data-toggle="tab" href="#tab-online">Online</a></li><li><a data-toggle="tab" href="#tab-recently">G&#7847;n &#273;&acirc;y</a></li><li><a data-toggle="tab" href="#tab-phancap">Ph&acirc;n c&#7845;p</a></li><li><a data-toggle="tab" href="#tab-friend">C&aacute; nh&acirc;n</a></li><li><a data-toggle="tab" href="#tab-nhom">Nh&oacute;m</a></li></ul>'),this.contact_tab_content=$('<div class="tab-content"></div>'),this.contact_tab_online=$('<div id="tab-online" class="tab-pane fade"></div>'),this.contact_tab_recent=$('<div id="tab-recently" class="tab-pane fade"></div>'),this.contact_tab_phancap=$('<div id="tab-phancap" class="tab-pane fade"></div>'),this.contact_tab_friend=$('<div id="tab-friend" class="tab-pane fade"></div>'),this.contact_tab_nhom=$('<div id="tab-nhom" class="tab-pane fade"></div>'),this.tab=[this.contact_tab_online,this.contact_tab_recent,this.contact_tab_phancap,this.contact_tab_friend,this.contact_tab_nhom],this.contact_content_search=$('<div class="live-search"><i class="fa fa-search"></i><input type="text" placeholder="T&igrave;m ki&#7871;m"></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.domStore=$("<div></div>"),this.setState=function(t){var e=this;e.state=_.assign(e.state,t),e.contact_content.removeClass("in"),e.contact_head.find(".btnclose-min").removeClass("open"),e.state.full&&(e.contact_content.addClass("in"),e.contact_head.find(".btnclose-min").addClass("open")),e.contact_tab_nav.find("li").eq(e.state.tab).click(),e.contact_tab_nav.find("li").eq(e.state.tab).hasClass("active")||(e.contact_tab_nav.find("li").eq(e.state.tab).addClass("active"),e.tab[e.state.tab].removeClass("fade").addClass("active"))},this.getState=function(){var t=this;return t.state},this.createContactor=function(t){var e=this,a=ct[t];if(a&&t!=F.id){var n=a.avatar&&""!=a.avatar?a.avatar:d,o=$('<div class="'+T+'"><div class="avatar"><img src="'+n+'"></div><div class="status"><span class="'+a.state+'">'+K(a.last)+'</span></div><div class="supporter"><div class="name">'+a.nickName+'</div><div class="text">'+a.status||"</div></div></div>");return o.click(function(){mt(c,{type:"user",id:t,title:a.nickName})}),e.contactDom[t]||(e.contactDom[t]=[]),e.contactDom[t].push(o),o}},this.contactor=function(t,e){var a=this,n=ct[t];if(n&&t!=F.id)return"online"==e?(a.onlineDom[t]?a.updateContactor(t,a.onlineDom[t]):a.onlineDom[t]=a.createContactor(t),a.onlineDom[t]):"friend"==e?(a.friendDom[t]?a.updateContactor(t,a.friendDom[t]):a.friendDom[t]=a.createContactor(t),a.friendDom[t]):"recent"==e?(a.recentDom[t]?a.updateContactor(t,a.recentDom[t]):a.recentDom[t]=a.createContactor(t),a.recentDom[t]):a.createContactor(t)},this.nhomContactor=function(t,e,a){var n=this,o=ct[e];if(o&&e!=F.id)return a?(n.recentDom[t][e]?n.updateContactor(e,n.recentDom[t][e]):n.recentDom[t][e]=n.createContactor(e),n.recentDom[t][e]):n.nhomDom[t]?(n.nhomDom[t][e]?n.updateContactor(e,n.nhomDom[t][e]):n.nhomDom[t][e]=n.createContactor(e),n.nhomDom[t][e]):void 0},this.groupDom=function(t,e){var a=this;e?a.recentDom[t.id]||(a.recentDom[t.id]={}):a.nhomDom[t.id]||(a.nhomDom[t.id]={});var n=a.panelCollapor(t.name);return t.member.forEach(function(o){n.panelContent.append(a.nhomContactor(t.id,o,e))}),n.panel.dblclick(function(){mt(c,{type:"group",id:t.id,title:t.name,member:t.member,creater:t.creater})}),n.panel},this.panelCollapor=function(t,e){var a=e||L(19),n=$('<div class="panel panel-default guid-blok"><div class="panel-heading"><a class="collapsed" data-toggle="collapse" data-parent="#expan" href="#'+a+'" aria-expanded="true" aria-controls="collapseOne"><span></span><strong>'+t+"</strong></a></div></div>"),o=$('<div id="'+a+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne" aria-expanded="true"></div>');return n.append(o),{panel:n,panelContent:o}},this.updateContactor=function(t,e){var a=ct[t].avatar&&""!=ct[t].avatar?ct[t].avatar:d;e.find(".avatar img").attr("src",a),e.find(".status span").remove(),e.find(".status").append('<span class="'+ct[t].state+'">'+K(ct[t].last)+"</span>"),e.find(".supporter .name").html(ct[t].nickName),e.find(".supporter .text").html(ct[t].status)},this.updateContact=function(t){var e=this;e&&e.contactDom[t]&&(e.contactDom[t].forEach(function(a){e.updateContactor(t,a)}),ct[t].state==R?e.contact_tab_online.find(".live-chat.list.contact-chat").prepend(e.contactor(t,"online")):e.onlineDom[t]&&e.domStore.append(e.onlineDom[t]))},this.loadRecent=function(t){var e=this;console.log(t),e.wrap.find(".number").remove();for(var a in e.recentDom)if(e.recentDom[a]instanceof $)e.domStore.append(e.recentDom[a]);else for(var n in e.recentDom[a])e.domStore.append(e.recentDom[a][n]);0==e.contact_tab_recent.find(".live-chat").length&&e.contact_tab_recent.append('<div class="live-chat chat-group contact-chat">');var o=e.contact_tab_recent.find(".live-chat");o.empty();var i=0;t&&t.forEach(function(t){if("group"==t.type){var a=lt[_.findIndex(lt,{id:t.id})];if(a){var n=e.groupDom(a,"recent");o.append(n),t.unread>0&&n.find("a").append('<span class="number">'+t.unread+"</span>")}}else{var n=e.contactor(t.id,"recent");o.append(n),t.unread>0&&n.append('<span class="number">'+t.unread+"</span>")}i+=t.unread}),i>0&&e.contact_tab_nav.find("li").eq(1).append('<span class="number">'+i+"</span>")},this.loadFriend=function(t){var e=this;for(var a in e.friendDom)e.domStore.append(e.friendDom[a]);0==e.contact_tab_friend.find(".live-chat").length&&e.contact_tab_friend.append('<div class="live-chat list contact-chat">');var n=e.contact_tab_friend.find(".live-chat");t&&t.forEach(function(t){n.append(e.contactor(t,"friend"))})},this.loadOnline=function(t){var e=this;for(var a in e.onlineDom)e.domStore.append(e.onlineDom[a]);0==e.contact_tab_online.find(".live-chat").length&&e.contact_tab_online.append('<div class="live-chat list chat-group contact-chat">');e.contact_tab_online.find(".live-chat");t&&t.forEach(function(t){ct[t].state=R,e.updateContact(t)})},this.loadNhom=function(t){var e=this;for(var a in e.nhomDom)if(e.nhomDom[a])for(var n in e.nhomDom[a])e.domStore.append(e.nhomDom[a][n]);else e.nhomDom[a]={};0==e.contact_tab_nhom.find(".live-chat").length&&e.contact_tab_nhom.append('<div class="live-chat chat-group contact-chat"></div>');var o=e.contact_tab_nhom.find(".live-chat");o.empty(),t&&t.forEach(function(t){o.append(e.groupDom(t))})},this.loadPhanCap=function(t,e){var a=this;if(!e){var n=a.panelCollapor(t.TenDonViCap1||t.TenDonViCap2||t.TenDonViCap3||t.TenDonViCap4,t.id||L(19));return t.subs&&t.subs.forEach(function(t){n.panelContent.append(a.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var e=t.id,o=a.contactor(e);n.panelContent.append(o)}),n}var n=$('<div class="live-chat chat-group contact-chat"></div>');t.subs&&t.subs.forEach(function(t){n.append(a.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var e=t.id,o=a.contactor(e);n.append(o)}),a.contact_tab_phancap.find(".live-chat").remove(),a.contact_tab_phancap.append(n)},this.init=function(){var t=this;_(t.tab).forEach(function(e){t.contact_tab_content.append(e)}),t.contact_content.append(t.contact_tab_nav),t.contact_content.append(t.contact_tab_content),t.contact_content.append(t.contact_content_search),t.wrap.append(t.contact_head),t.wrap.append(t.contact_content),t.dom.append(t.wrap),t.setState();var e=t.contact_head.find("a.btnclose-min");e.click(function(){t.state.full=0==t.state.full,t.setState(),mt(r,t.state)}),t.contact_tab_nav.find("li").click(function(){t.state.tab=$(this).index(),mt(r,t.state)});var a=t.contact_head.find(".btn-addgroup");return a.click(function(){tt({creater:F.id},D,function(e){lt.push(e),t.loadNhom(lt);var a={id:e.id,title:e.name,type:"group",member:e.member,creater:e.creater};mt(c,a)})}),t.loadPhanCap(rt,!0),t.loadFriend(F.friends),t.loadNhom(lt),t.loadRecent(F.recent),t.loadOnline(dt),t},this.init()},mt=function(t,a){if(t===c){bt=bt||{},bt[a.id]||(bt[a.id]=new ft(a,{show:!0,full:!0}),pt.append(bt[a.id].dom)),xt(a.id,!0)}t===s&&(F=_.assign(F,a),Y(N,F),gt.loadFriend(F.friends)),t===r&&(ht=_.assign(ht,{state:a}),Y(M,ht)),t===o&&e.emit(l,a),t===m&&e.emit(m,a),t===i&&xt()},ht=Q(M),vt=Q(j),bt={},gt={},_t=function(t,e){bt=bt||{},t.from===F.id?(t.toUser&&(bt[t.toUser]?bt[t.toUser].displayMessage(t,e,!0):(bt[t.toUser]=new ft({id:t.toUser,type:"user"},{show:!1,full:!0}),pt.append(bt[t.toUser].dom),xt(t.toUser,!1))),t.toGroup&&(bt[t.toGroup]?bt[t.toGroup].displayMessage(t,e,!0):(bt[t.toGroup]=new ft({id:t.toGroup,type:"group"},{show:!1,full:!0}),pt.append(bt[t.toGroup].dom),xt(t.toGroup,!1)))):t.toUser&&t.toUser==F.id?bt[t.from]?bt[t.from].displayMessage(t,e,!0):(bt[t.from]=new ft({id:t.from,type:"user"},{show:!1,full:!0}),pt.append(bt[t.from].dom),xt(t.from,!1)):bt[t.toGroup]?bt[t.toGroup].displayMessage(t,e,!0):(bt[t.toGroup]=new ft({id:t.toGroup,type:"group"},{show:!1,full:!0}),pt.append(bt[t.toGroup].dom),xt(t.toGroup,!1))},xt=function(t,e){var a=e?1:0;ht={time:(new Date).getTime(),item:[],state:gt.getState()};for(var n in bt){var o=bt[n].state.show;o&&2==a&&(o=!1),o&&a++,t&&e&&n==t&&(o=!0);var i={show:o,online:dt.indexOf(n)!==-1};bt[n].setState(i),bt[n].state.show&&ht.item.push(_.assign(bt[n].box,{state:bt[n].state}))}if(t&&a<2){var i={show:!0,online:dt.indexOf(t)!==-1};bt[t].setState({show:!0}),ht.item.push(_.assign(bt[t].box,{state:bt[t].state}))}Y(M,ht)},yt=function(){e.on(u,function(t,e){t!=vt&&(console.log("load lai contact va phan cap khi co du lieu moi"),Y(j,t),at(F.userId,"contacts",void 0,void 0,"phancap",void 0,void 0,function(t){console.log("load lai contact va phan cap khi co du lieu moi"),F=_.assign(F,t.user),Y(N,F),ct={},t.users.forEach(function(t){ct[t.id]=t}),Y(E,ct),rt=t.phancap.phancap||rt,Y(G,rt)})),J=new Date-e}),e.on(y,function(t){try{ct[t].state=B,gt.updateContact(t),bt[t]&&bt[t].setState({online:!1})}catch(t){console.log(t)}}),e.on(x,function(t){ct[t].state=R,gt.updateContact(t),bt[t]&&bt[t].setState({online:!0})}),e.on(p,function(t,e){if(F.recent&&t.from!=F.id){console.log("update recent",t);var a=t.toGroup||t.from,n=_.findIndex(F.recent,{id:a});n==-1?F.recent.push({id:a,unread:1,last:t.time}):(F.recent[n].unread++,F.recent[n].last=t.time),F.recent.sort(function(t,e){return t.last<e.last})}gt.loadRecent(F.recent),e&&console.log("receice message temp",t,e),_t(t,e)}),e.on(v,function(t){var e=_.findIndex(lt,{id:t.group.id});e!==-1?t.leave&&_.indexOf(t.leave,F.id)!=-1?(alert("Bạn đã rời khỏi nhóm "+lt[e].name),F.recent&&F.recent.splice(_.findIndex(F.recent,function(e){return e.id==t.group.id}),1),lt.splice(e,1),gt.loadNhom(lt),gt.loadRecent(F.recent),bt[t.group.id]&&(bt[t.group.id].setState({show:!1}),xt())):(lt[e]=t.group,gt.loadNhom(lt),gt.loadRecent(F.recent),bt[t.group.id]&&(bt[t.group.id].updateBox({id:t.group.id,type:"group",creater:t.group.creater,title:t.group.name,member:t.group.member}),xt())):t.join&&_.indexOf(t.join,F.id)!=-1&&(alert("Bạn đã được mời vào nhóm "+t.group.name),lt.push(t.group),gt.loadNhom(lt))}),e.on(b,function(t){var e=_.findIndex(lt,{id:t});e!=-1&&(alert("Nhóm "+lt[e].name+" đã bị xóa."),F.recent&&F.recent.splice(_.findIndex(F.recent,function(e){return e.id==t}),1),lt.splice(e,1),bt[t]&&bt[t].setState({show:!1}),gt.loadNhom(lt),gt.loadRecent(F.recent))}),e.on(g,function(t){}),e.on(h,function(t){if(console.log("get read message"),F.recent){var e=_.findIndex(F.recent,{id:t.boxId});e!=-1&&(_.assign(F.recent[e],{unread:0}),console.log("get read message",F.recent[e]),gt.loadRecent(F.recent))}}),e.emit(f,F)};return this.dom=pt,this.init=function(){var t=this;n=document.title;var e=Q(N),a={full:!1,tab:0};return e&&e.userId==F.userId?(F=e,ht&&ht.state&&(a=ht.state),at(F.userId,void 0,"online",void 0,void 0,"friend","group",function(t){F=_.assign(F,t.user),Y(N,F),dt=t.online,lt=t.group,gt=new ut(a,F.nickName),pt.append(gt.dom),ht&&new Date-ht.time<9e6?ht.item.forEach(function(t){bt[t.id]=new ft(t,t.state),pt.append(bt[t.id].dom)}):(ht={time:(new Date).getTime(),item:[],state:{full:!1,tab:0}},Y(M,ht)),yt()})):at(F.userId,"contacts","online","recently","phancap","friend","group",function(t){F=_.assign(F,t.user),Y(N,F),ct={},t.users.forEach(function(t){ct[t.id]=t}),Y(E,ct),dt=t.online,rt=t.phancap.phancap||{},Y(G,rt),lt=t.group,gt=new ut(a,ct[F.id].nickName),pt.append(gt.dom),ht={time:(new Date).getTime(),item:[],state:{full:!1,tab:0}},Y(M,ht),yt()}),$(window).unload(function(){xt()}),t},this.init()};