function chat_timeoffline(t){try{if(!t)return"";var a=new Date,e=parseInt((a-t)/1e3);return e>=31536e3?parseInt(e/31536e3)+" năm":e>=2592e3?parseInt(e/2592e3)+" tháng":e>=86400?parseInt(e/86400)+" ngày":e>=3600?parseInt(e/3600)+" giờ":e>=60?parseInt(e/60)+" phút":parseInt(e)+" giây"}catch(t){return""}}function chat_locdau(t){return t=t.toLowerCase(),t=t.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),t=t.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),t=t.replace(/ì|í|ị|ỉ|ĩ/g,"i"),t=t.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),t=t.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),t=t.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),t=t.replace(/đ/g,"d"),t=t.replace(/^\-+|\-+$/g,"")}function chat_randomstring(t){for(var a="",e=function(){var t=Math.floor(62*Math.random());return t<10?t:t<36?String.fromCharCode(t+55):String.fromCharCode(t+61)};a.length<t;)a+=e();return a}function chat_formatDate(t){t="number"==typeof t?new Date(t):t;var a=["Chủ nhật","Thứ hai","Thứ ba","Thứ tư","Thứ năm","Thứ sáu","Thứ bảy"];return a[t.getDay()]+", ngày "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()}function chat_compareDate(t,a){return t="number"==typeof t?new Date(t):t,a="number"==typeof a?new Date(a):a,t.toDateString()===a.toDateString()}function chat_localStorage(t,a){localStorage[t]=JSON.stringify(a)}function chat_get_localStorage(t){if(STORAGE_RESET&&localStorage[t])return JSON.parse(localStorage[t])}function chat_remove_localStorage(){localStorage.removeItem(STORAGE_VERSION),localStorage.removeItem(STORAGE_MESSAGE),localStorage.removeItem(STORAGE_USER),console.log("remove localStorage"),STORAGE_RESET=!1}function chat_queryGraphql(t,a,e){$.getJSON(t,a).done(function(t){e(t)}).error(function(t,a,e){console.log("error "+a),console.log("incoming Text "+t.responseText)})}function chat_check_user(t){var a=chat_get_localStorage(STORAGE_USER);if(a){if(a.userId==t.userId)return a;chat_remove_localStorage()}return chat_localStorage(STORAGE_USER,t),t}var CHATBOX_SEND_MESSAGE="sendmessage",CHATBOX_VIEW_MESSAGE="view message",CHATBOX_TYPING="typing message",CHATBOX_END_TYPING="end typing message",CHATBOX_CLOSE="chatbox close",CHATBOX_ADD_CONTACT="add contact",CHATBOX_REMOVE_CONTACT="remove contact",CHATCONTACT_CALL_INSTANCE="call instance",CHATCONTACT_SET_STATE="chat contact set state",CHATCONTACT_RELOAD="reload",GET_AVATAR="get avatar",AVATAR_DEFAULT="/img/male.png",SOCKET_SEND_MESSAGE="socket send message",SOCKET_GET_MESSAGE="socket get message",SOCKET_SEND_TYPING="socket send typing",SOCKET_GET_TYPING="socket get typing",SOCKET_SEND_END_TYPING="socket send end typing",SOCKET_GET_END_TYPING="socket get end typing",SOCKET_SEND_CONNECT="socket send connect",SOCKET_GET_CONNECT="socket get connect",SOCKET_SEND_DISCONECT="socket send disconnect",SOCKET_GET_DISCONNECT="socket get disconnect",SOCKET_SEND_READ_MESSAGE="socket send read message",SOCKET_GET_SEND_MESSAGE="socket get send message",SOCKET_BROADCAST_CONNECT="socket broadcast connect",SOCKET_BROADCAST_DISCONNECT="socket broadcast disconnect",MESSAGE_OLD="old",MESSAGE_NEW="new",MESSAGE_READ="read",MESSAGE_SENDER="visitor_chat",MESSAGE_RECEIVER="supporter_chat",MESSAGE_LIMIT=10,STORAGE_USER="chat_user",STORAGE_VERSION="chat_version",STORAGE_PHANCAP="chat_phancap",STORAGE_CONTACT="chat_contact",STORAGE_CURRENT="chat_current",STORAGE_RESET=!0,ONLINE="online",OFFLINE="offline",CHAT_SERVER="http://localhost:3000",TIMEOFFSET=0,ChatBox=function(t,a,e,o,n,s){return this.user=t,this.box=a,this.contacts=n,this.callback=e,this.state=o||{show:!0,full:!0,online:!1,new:0,title:""},this.box_head=$('<div class="live-hd"><div class="pull-left visitor-name">'+this.box.title+'</div><div class="pull-right"><a href="javascript:void(0)"><i class="glyphicon glyphicon-cog"></i></a><a href="javascript:void(0)" class="btnclose-min"><i class="glyphicon glyphicon-chevron-down"></i><i class="glyphicon glyphicon-chevron-up"></i></a><a href="javascript:void(0)"><i class="glyphicon glyphicon-remove"></i></a></div><div class="clearfix"></div></div>'),this.box_content_top=$('<div class="live-ct-top"><a href=""><i class="glyphicon glyphicon-dashboard"></i></a><a href=""><i class="glyphicon glyphicon-info-sign"></i></a></div>'),this.box_content_search=$('<div class="live-search"><i class="glyphicon glyphicon-search"></i><input type="text" placeholder="Tìm kiếm"></div>'),this.box_content_input=$('<div class="live-chat-ft"><div class="textarea"><textarea placeholder="Nhập nội dung"></textarea></div><button class="btn btn-submit">Gửi</button><a href="" class="btn btn-attach" title="Đính kèm file"><i class="glyphicon glyphicon-paperclip"></i></a></div>'),this.box_content=$('<div class="live-ct"></div>'),this.box_content_chat=$('<div class="live-chat"></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.messages=s||[],this.dates=[],this.setState=function(t){var a=this;a.state=_.assign(a.state,t),a.dom.removeClass("hidden"),0==a.state.show&&a.dom.addClass("hidden"),a.box_content.removeClass("in"),a.box_head.find(".btnclose-min").removeClass("open"),a.state.full&&(a.box_content.addClass("in"),a.box_head.find(".btnclose-min").addClass("open")),a.box_head.find(".online").remove(),a.state.online&&a.box_head.prepend('<span class="online pull-left"></span>')},this.displayMessage=function(t,a){var e=this;t.idtemp&&t.id&&console.log(t),t.time=t.time||new Date-TIMEOFFSET;var o=chat_formatDate(t.time),n=_.findIndex(e.dates,function(a){return chat_compareDate(a.date,t.time)});if(n==-1){var s=$('<time class="text-right">'+o+"</time>");!_.last(e.dates)||t.time>_.last(e.dates).date?(e.box_content_chat.append(s),e.dates.push({date:t.time,dom:s})):(e.box_content_chat.prepend(s),e.dates.splice(0,0,{date:t.time,dom:s}))}t.dom||(t.dom=$('<div class="line_message"><div class="content_message">'+t.content+"</div></div>"),t.dom.dblclick(function(){alert(new Date(t.time))}));var c=_.findIndex(e.messages,function(a){return a.time>t.time});if(c==-1){if(_.last(e.messages)&&_.last(e.messages).from==t.from&&n!==-1)_.last(e.messages).dom.after(t.dom);else if(t.from==e.user.id){var i=$('<div class="'+MESSAGE_SENDER+'"></div>');i.append(t.dom),e.box_content_chat.append(i)}else{var i=$('<div class="'+MESSAGE_RECEIVER+'"><div class="avatar"><img src="'+(e.contacts[t.from].avatar||AVATAR_DEFAULT)+'"></div> </div>');i.append(t.dom),e.box_content_chat.append(i)}e.messages.push(t)}else{if(e.messages[c].from===t.from&&n!==-1)e.messages[c].dom.before(t.dom);else if(t.from==e.user.id){var i=$('<div class="'+MESSAGE_SENDER+'"></div>');i.append(t.dom),e.dates[0].dom.after(i)}else{var i=$('<div class="'+MESSAGE_RECEIVER+'"><div class="avatar"><img src="'+(e.contacts[t.from].avatar||AVATAR_DEFAULT)+'"></div> </div>');i.append(t.dom),e.dates[0].dom.after(i)}e.messages.splice(c,0,t)}a&&e.box_content_chat.scrollTop(1e10)},this.scrollMessage=function(t){},this.createMessage=function(t){var a=this;return"group"==a.box.type?{idtemp:chat_randomstring(8),from:a.user.id,toGroup:a.box.id,content:t}:{idtemp:chat_randomstring(8),from:a.user.id,toUser:a.box.id,content:t}},this.loadMessage=function(t){var a=this,e=void 0,o={time:-1};if(t){var n=_.first(a.messages)?_.first(a.messages).time:void 0;e={$lt:n}}if("group"==a.box.type){var s={query:{toGroup:a.box.id},page:0,limit:MESSAGE_LIMIT};e&&(s.query.time=e),s.sort=o;var c="id, content, time, state, from, toGroup";chat_queryGraphql(CHAT_SERVER+"/graphql",'query={message(q:"'+JSON.stringify(s).replace(/"/g,'\\"')+'"){'+c+"}}",function(e){var o=e.data.message||[];o.forEach(function(e){e.time=parseInt(e.time);var o=!t;a.displayMessage(e,o)})})}else{var s={query:{$or:[{toUser:a.user.id,from:a.box.id},{toUser:a.box.id,from:a.user.id}]},page:0,limit:MESSAGE_LIMIT};e&&(s.query.time=e),s.sort=o;var c="id, content, time, state, from, toUser";chat_queryGraphql(CHAT_SERVER+"/graphql",'query={message(q:"'+JSON.stringify(s).replace(/"/g,'\\"')+'"){'+c+"}}",function(e){var o=e.data.message||[];o.forEach(function(e){e.time=parseInt(e.time);var o=!t;a.displayMessage(e,o)})})}},this.init=function(){var t=this;t.user.id||t.loadUser(),t.wrap.append(t.box_head),t.box_content.append(t.box_content_top),t.box_content.append(t.box_content_chat),t.box_content.append(t.box_content_search),t.box_content.append(t.box_content_input),t.wrap.append(t.box_content),t.dom.append(t.wrap),t.setState(),t.box_content_chat.scroll(function(){0===$(this).scrollTop()&&t.loadMessage(!0)});var a=t.box_head.find("a.btnclose-min");a.on("click",function(){t.state.full=0==t.state.full,t.setState(),t.callback(CHATBOX_CLOSE)});var e=t.box_head.find("a .glyphicon-remove");e.on("click",function(a){t.state.show=!1,t.setState(),t.callback(CHATBOX_CLOSE)});var o=t.box_content_input.find("textarea");t.box_content_input.find("button");return o.keydown(function(a){if(13==a.keyCode&&a.shiftKey){var e=$(this).val();return $(this).val(e+"\n"),void a.stopPropagation()}if(13==a.which&&(a.preventDefault(),""!==$(this).val())){var o=t.createMessage($(this).val());t.callback(CHATBOX_SEND_MESSAGE,o),$(this).val(""),t.displayMessage(o,!0)}}),o.focus(function(){}),t.loadMessage(),t},this.init()},ChatContact=function(t,a,e,o,n,s){return this.user=t,this.callback=a,this.state=e||{tab:0,full:!1},this.title=o,this.contacts=n||{},this.phancap=s||{},this.contactDom={},this.contact_head=$('<div class="live-hd"><div class="pull-left visitor-name">'+this.title+'</div><div class="pull-right"><a href="javascript:void(0)"><i class="glyphicon glyphicon-cog"></i></a><a href="javascript:void(0)" class="btnclose-min"><i class="glyphicon glyphicon-chevron-down"></i><i class="glyphicon glyphicon-chevron-up"></i></a><a href="javascript:void(0)"><i class="glyphicon glyphicon-remove"></i></a></div><div class="clearfix"></div></div>'),this.contact_content=$('<div class="live-ct"></div>'),this.contact_tab_nav=$('<ul class="nav nav-tabs"><li><a data-toggle="tab" href="#tab-online">Online</a></li><li><a data-toggle="tab" href="#tab-recently">Gần đây</a></li><li><a data-toggle="tab" href="#tab-phancap">Phân cấp</a></li><li><a data-toggle="tab" href="#tab-friend">Cá nhân</a></li><li><a data-toggle="tab" href="#tab-nhom">Nhóm</a></li></ul>'),this.contact_tab_content=$('<div class="tab-content"></div>'),this.contact_tab_online=$('<div id="tab-online" class="tab-pane fade"></div>'),this.contact_tab_recently=$('<div id="tab-recently" class="tab-pane fade"></div>'),this.contact_tab_phancap=$('<div id="tab-phancap" class="tab-pane fade"></div>'),this.contact_tab_friend=$('<div id="tab-friend" class="tab-pane fade"></div>'),this.contact_tab_nhom=$('<div id="tab-nhom" class="tab-pane fade"></div>'),this.tab=[this.contact_tab_online,this.contact_tab_recently,this.contact_tab_phancap,this.contact_tab_friend,this.contact_tab_nhom],this.contact_content_search=$('<div class="live-search"><i class="glyphicon glyphicon-search"></i><input type="text" placeholder="Tìm kiếm"></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.setState=function(t){var a=this;a.state=_.assign(a.state,t),a.contact_content.removeClass("in"),a.contact_head.find(".btnclose-min").removeClass("open"),a.state.full&&(a.contact_content.addClass("in"),a.contact_head.find(".btnclose-min").addClass("open")),a.contact_tab_nav.find("li").eq(a.state.tab).click(),a.contact_tab_nav.find("li").eq(a.state.tab).hasClass("active")||(a.contact_tab_nav.find("li").eq(a.state.tab).addClass("active"),a.tab[a.state.tab].removeClass("fade").addClass("active"))},this.getState=function(){var t=this;return t.state},this.contactor=function(a){var e=this,o=e.contacts[a];if(o&&a!=t.id){var n=o.avatar&&""!=o.avatar?o.avatar:AVATAR_DEFAULT,s=$('<div class="'+MESSAGE_RECEIVER+'"><div class="avatar"><img src="'+n+'"></div><div class="status"><span class="'+o.state+'">'+chat_timeoffline(o.last)+'</span></div><div class="supporter"><div class="name">'+o.nickName+'</div><div class="text">'+o.status||"</div></div></div>");return s.click(function(){e.callback(CHATCONTACT_CALL_INSTANCE,{type:"user",id:a,title:o.nickName})}),e.contactDom[a]||(e.contactDom[a]=[]),e.contactDom[a].push(s),s}},this.groupDom=function(t){var a=this,e=a.panelCollapor(t.name,t.id);return t.member.forEach(function(t){var o=a.contactor(t);e.panelContent.append(o)}),e.panel.dblclick(function(){a.callback(CHATCONTACT_CALL_INSTANCE,{type:"group",id:t.id,title:t.name})}),e.panel},this.getContact=function(t){var a=this,e=_.find(a.contacts,function(a){return a.id==t});return e},this.panelCollapor=function(t,a){var e=a||chat_randomstring(19),o=$('<div class="panel panel-default guid-blok"><div class="panel-heading"><a class="collapsed" data-toggle="collapse" data-parent="#expan" href="#'+e+'" aria-expanded="true" aria-controls="collapseOne"><span></span><strong>'+t+"</strong></a></div></div>"),n=$('<div id="'+e+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne" aria-expanded="true"></div>');return o.append(n),{panel:o,panelContent:n}},this.updateContactor=function(t,a){var e=this;a.find(".avatar img").attr("src",e.contacts[t].avatar),a.find(".status span").remove(),a.find(".status").append('<span class="'+e.contacts[t].state+'">'+chat_timeoffline(e.contacts[t].last)+"</span>"),a.find(".supporter .name").html(e.contacts[t].nickName),a.find(".supporter .text").html(e.contacts[t].status)},this.updateContact=function(t){var a=this;a&&a.contactDom[t]&&a.contactDom[t].forEach(function(e){a.updateContactor(t,e)})},this.loadData=function(){arguments[0](loadData(arguments.splice(0,1)))},this.loadContact=function(t){var a=this;a.contacts=t||{},a.callback(CHATCONTACT_RELOAD)},this.loadOnline=function(t){var a=this,e=$('<div class="live-chat list contact-chat">');if(a.contacts)if(t)_(t).forEach(function(t){a.contacts[t].state=ONLINE;var o=a.contactor(t);e.append(o),a.updateContact(t)});else for(var o in a.contacts)if(a.contacts[o].state==ONLINE){var n=a.contactor(o);e.append(n)}a.contact_tab_online.find(".live-chat").remove(),_.remove(a.contactDom,function(t){return 0===t.length}),a.contact_tab_online.append(e)},this.loadRecently=function(t){var a=this,e=$('<div class="live-chat list contact-chat">');a.contact_tab_recently.find(".live-chat").remove(),a.contact_tab_recently.append(e)},this.loadFriend=function(t){var a=this,e=$('<div class="live-chat list contact-chat">');t&&t.forEach(function(t){var e=a.contactor(t);a.friendDom.append(e)}),a.contact_tab_friend.find(".live-chat").remove(),a.contact_tab_friend.append(e)},this.loadNhom=function(t){var a=this,e=$('<div class="live-chat chat-group contact-chat"></div>');t&&t.forEach(function(t){var o=a.groupDom(t);e.append(o)}),a.contact_tab_nhom.find(".live-chat").remove(),a.contact_tab_nhom.append(e)},this.loadPhanCap=function(t,a){var e=this;if(!a){var o=e.panelCollapor(t.TenDonViCap1||t.TenDonViCap2||t.TenDonViCap3||t.TenDonViCap4,t.id||chat_randomstring(19));return t.subs&&t.subs.forEach(function(t){o.panelContent.append(e.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var a=t.id,n=e.contactor(a);o.panelContent.append(n)}),o}var o=$('<div class="live-chat chat-group contact-chat"></div>');t.subs&&t.subs.forEach(function(t){o.append(e.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var a=t.id,n=e.contactor(a);o.append(n)}),e.contact_tab_phancap.find(".live-chat").remove(),e.contact_tab_phancap.append(o)},this.init=function(){var t=this;_(t.tab).forEach(function(a){t.contact_tab_content.append(a)}),t.contact_content.append(t.contact_tab_nav),t.contact_content.append(t.contact_tab_content),t.contact_content.append(t.contact_content_search),t.wrap.append(t.contact_head),t.wrap.append(t.contact_content),t.dom.append(t.wrap),t.setState();var a=t.contact_head.find("a.btnclose-min");return a.click(function(){t.state.full=0==t.state.full,t.setState(),t.callback(CHATCONTACT_SET_STATE,t.state)}),t.contact_tab_nav.find("li").click(function(){t.state.tab=$(this).index(),t.callback(CHATCONTACT_SET_STATE,t.state)}),t.loadPhanCap(t.phancap,!0),t.loadNhom(),t.loadRecently(),t.loadFriend(),t.loadOnline(),t},this.init()},ChatApp=function(t,a){return this.user=t,this.socket=a,this.version=chat_get_localStorage(STORAGE_VERSION),this.contacts=chat_get_localStorage(STORAGE_CONTACT),this.phancap=chat_get_localStorage(STORAGE_PHANCAP),this.userOnline=[],this.boxs=chat_get_localStorage(STORAGE_CURRENT),this.dom=$("<div id='chatapp' class='chat-app'></div>"),this.listBox={},this.loadUser=function(t){var a=this,e={query:{userId:a.user.userId},page:0,limit:1},o="id, userId,nickName,avatar";console.log(e),chat_queryGraphql(CHAT_SERVER+"/graphql",'query={user(q:"'+JSON.stringify(e).replace(/"/g,'\\"')+'"){'+o+"}}",function(a){t(a.data.user[0])})},this.loadContact=function(t,a){var e=this,o={criteria:{},page:0,limit:3e3,column:"_id nickName last avatar last state"},n=t||"id, nickName, last, avatar, last, state";chat_queryGraphql(CHAT_SERVER+"/graphql",'query={user(q:"'+JSON.stringify(o).replace(/"/g,'\\"')+'"){'+n+"}}",function(t){var o=t.data.user||[];o.forEach(function(t){e.contacts[t.id]=t}),e.chatContact.loadContact(e.contacts),chat_localStorage(STORAGE_CONTACT,e.contacts),a&&a()})},this.loadPhanCap=function(t){var a=this,e="{phancap{phancap{members {id }, subs {TenDonViCap2, members{id }, subs {TenDonViCap3, members{id }, subs{TenDonViCap4, members{id } } } } } }}";chat_queryGraphql(CHAT_SERVER+"/graphql","query="+e,function(e){a.phancap=e.data.phancap.phancap||{},a.chatContact.loadPhanCap(a.phancap,!0),chat_localStorage(STORAGE_PHANCAP,a.phancap),t&&t()})},this.loadNhom=function(t){var a=this,e={user:{id:a.user.id}},o='{group(q:"'+JSON.stringify(e).replace(/"/g,'\\"')+'"){id member name creater}}';chat_queryGraphql(CHAT_SERVER+"/graphql","query="+o,function(e){var o=e.data.group||[];a.chatContact.loadNhom(o),t&&t()})},this.loadFriendRecently=function(t){var a=this,e={criteria:{},page:0,limit:1,column:"friends"},o="friends recently";chat_queryGraphql(CHAT_SERVER+"/graphql",'query={user(q:"'+JSON.stringify(e).replace(/"/g,'\\"')+'"){'+o+"}}",function(e){var o=e.data.user[0].friends||[];a.chatContact.loadFriend(o),t&&t()})},this.receiveMessage=function(t){var a=this;a.listBox=a.listBox||{},t.from===a.user.id?(t.toUser&&(a.listBox[t.toUser]?a.listBox[t.toUser].displayMessage(t):(a.listBox[t.toUser]=new ChatBox(a.user,{id:t.toUser,type:"user",title:a.contacts[t.toUser].nickName},function(t,e){a.callsocket(t,e)},{show:!1,full:!0},a.contacts),a.dom.append(a.listBox[t.toUser].dom),a.showBox(t.toUser,!1))),t.toGroup&&(a.listBox[t.toGroup]?a.listBox[t.toGroup].displayMessage(t):(a.listBox[t.toGroup]=new ChatBox(a.user,{id:t.toGroup,type:"group",title:""},function(t,e){a.callsocket(t,e)},{show:!1,full:!0},a.contacts),a.dom.append(a.listBox[t.toGroup].dom),a.showBox(t.toGroup,!1)))):t.toUser&&t.toUser==a.user.id?a.listBox[t.from]?a.listBox[t.from].displayMessage(t):(a.listBox[t.from]=new ChatBox(a.user,{id:t.from,type:"user",title:a.contacts[t.from].nickName},function(t,e){a.callsocket(t,e)},{show:!1,full:!0},a.contacts),a.dom.append(a.listBox[t.from].dom),a.showBox(t.from,!1)):a.listBox[t.toGroup]?a.listBox[t.toGroup].displayMessage(t):(a.listBox[t.toGroup]=new ChatBox(a.user,{id:t.toGroup,type:"group",title:""},function(t,e){a.callsocket(t,e)},{show:!1,full:!0},a.contacts),a.dom.append(a.listBox[t.toGroup].dom),a.showBox(t.toGroup,!1))},this.showBox=function(t,a){var e=this,o=a?1:0;e.boxs={time:(new Date).getTime(),item:[],state:e.chatContact.getState()};for(var n in e.listBox){var s=e.listBox[n].state.show;s&&2==o&&(s=!1),s&&o++,t&&a&&n==t&&(s=!0);var c={show:s,online:e.userOnline.indexOf(t)!==-1};e.listBox[n].setState(c),e.listBox[n].state.show&&e.boxs.item.push(_.assign(e.listBox[n].box,{state:e.listBox[n].state}))}t&&o<2&&(e.listBox[t].setState({show:!0}),e.boxs.item.push(_.assign(e.listBox[t].box,{state:e.listBox[t].state}))),chat_localStorage(STORAGE_CURRENT,e.boxs)},this.callsocket=function(t,a){var e=this;if(t===CHATCONTACT_CALL_INSTANCE){e.listBox=e.listBox||{},e.listBox[a.id]||(e.listBox[a.id]=new ChatBox(e.user,a,function(t,a){e.callsocket(t,a)},{show:!0,full:!0},e.contacts),e.dom.append(e.listBox[a.id].dom)),e.showBox(a.id,!0)}t===CHATCONTACT_SET_STATE&&(e.boxs=_.assign(e.boxs,{state:a}),console.log(e.boxs),chat_localStorage(STORAGE_CURRENT,e.boxs)),t===CHATCONTACT_RELOAD&&(e.loadPhanCap(),e.loadFriendRecently(),e.loadNhom(),a&&e.chatContact.loadOnline(e.userOnline)),t===CHATBOX_SEND_MESSAGE&&e.socket.emit(SOCKET_SEND_MESSAGE,a),t===CHATBOX_CLOSE&&e.showBox()},this.setSocket=function(){var t=this;return t.socket.on(SOCKET_GET_CONNECT,function(a,e,o){e!=t.version&&(t.contacts={},t.loadContact(),t.loadPhanCap(),chat_localStorage(STORAGE_VERSION,e)),TIMEOFFSET=new Date-o,_(a).forEach(function(a){t.listBox[a]&&t.listBox[a].setState({online:!0}),t.contacts[a]&&(t.contacts[a].state=ONLINE),t.chatContact.updateContact(a)})}),t.socket.on(SOCKET_BROADCAST_DISCONNECT,function(a){t.contacts[a].state=OFFLINE,t.chatContact.updateContact(a),t.listBox[a]&&t.listBox[a].setState({online:!1})}),t.socket.on(SOCKET_BROADCAST_CONNECT,function(a){t.contacts[a].state=ONLINE,t.chatContact.updateContact(a),t.listBox[a]&&t.listBox[a].setState({online:!0})}),t.socket.on(SOCKET_GET_MESSAGE,function(a){t.receiveMessage(a)}),t.socket.emit(SOCKET_SEND_CONNECT,t.user),t.socket},this.chatContact,this.init=function(){var t=this,a=chat_get_localStorage(STORAGE_USER);return a&&a.userId==t.user.userId?(t.user=a,t.chatContact=new ChatContact(t.user,function(a,e){t.callsocket(a,e)},t.boxs.state||void 0,"",t.contacts,t.phancap),t.dom.append(t.chatContact.dom),t.boxs&&new Date-t.boxs.time<9e6?t.boxs.item.forEach(function(a){t.listBox[a.id]=new ChatBox(t.user,a,function(a,e){t.callsocket(a,e)},a.state,t.contacts),t.dom.append(t.listBox[a.id].dom)}):(t.boxs={time:new Date,item:[],state:{full:!1,tab:0}},chat_localStorage(STORAGE_CURRENT,t.boxs)),t.loadNhom(),t.socket=t.setSocket()):t.loadUser(function(a){t.user=_.assign(t.user,a),chat_localStorage(STORAGE_USER,t.user),t.chatContact=new ChatContact(t.user,function(a,e){t.callsocket(a,e)},t.boxs.state||void 0,"",t.contacts,t.phancap),t.dom.append(t.chatContact.dom),t.boxs={time:new Date,item:[],state:{full:!1,tab:0}},chat_localStorage(STORAGE_CURRENT,t.boxs),t.contacts||(t.contacts={},t.loadContact(function(){t.phancap||t.loadPhanCap(),t.loadNhom()})),t.socket=t.setSocket()}),t},this.init()};