var ChatApp=function(t,e,a){var n="sendmessage",i="chatbox close",o="call instance",s="chat contact set state",c="chat contact create group",r="/img/male.png",d="socket send message",l="socket get message",p="socket send connect",h="socket get connect",u="socket broadcast connect",f="socket broadcast disconnect",v="creat group",m="update group",b="update group local",g="visitor_chat",x="supporter_chat",w=10,y="chat_user",C="chat_version",k="chat_phancap",D="chat_contact",S="chat_current",q=!0,T="online",G="offline",N=a||"",O=0,j=t,I=function(t){try{if(!t)return"";var e=new Date,a=parseInt((e-t)/1e3);return a>=31536e3?parseInt(a/31536e3)+" n&#259;m":a>=2592e3?parseInt(a/2592e3)+" th&aacute;ng":a>=86400?parseInt(a/86400)+" ng&agrave;y":a>=3600?parseInt(a/3600)+" gi&#7901;":a>=60?parseInt(a/60)+" ph&uacute;t":parseInt(a)+" gi&acirc;y"}catch(t){return""}},M=function(t){for(var e="",a=function(){var t=Math.floor(62*Math.random());return t<10?t:t<36?String.fromCharCode(t+55):String.fromCharCode(t+61)};e.length<t;)e+=a();return e},E=function(t){t="number"==typeof t?new Date(t):t;var e=["Ch&#7911; nh&#7853;t","Th&#7913; hai","Th&#7913; ba","Th&#7913; t&#432;","Th&#7913; n&#259;m","Th&#7913; s&aacute;u","Th&#7913; b&#7843;y"];return e[t.getDay()]+", ng&agrave;y "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()},U=function(t,e){return t="number"==typeof t?new Date(t):t,e="number"==typeof e?new Date(e):e,t.toDateString()===e.toDateString()},R=function(t,e){localStorage||(localStorage={}),localStorage[t]=JSON.stringify(e)},A=function(t){if(localStorage||(localStorage={}),q&&localStorage[t])return JSON.parse(localStorage[t])},P=function(t,e,a,n){console.log(t,e,a,n);var i=new XMLHttpRequest;i.responseType="json",i.open("POST",t),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),i.setRequestHeader("Accept-Language","en-US,en;q=0.5"),i.setRequestHeader("Access-Control-Allow-Origin","*"),i.onload=function(){n(i.response)},i.send(JSON.stringify({query:e,variables:a}))},V=function(t,e,a){t.action=e;var n={g:t},i="mutation UpdateGroup($g:groupInput){updateGroup(g:$g) {id,member,name,creater}}";P(N+"/graphql",i,n,function(t){t.data.updateGroup?a(t.data.updateGroup):alert("Khong the tao Nhom luc nay")})},J=function(t,e,a,n,i,o,s,c){var r=[];t&&r.push('user(q:"'+t+'"){id,userId,nickName,avatar}'),e&&r.push('users(q:"'+JSON.stringify({query:{},limit:3e3}).replace(/"/g,'\\"')+'"){id,nickName,last,avatar,last}'),a&&r.push("online"),i&&r.push("phancap{phancap{members {id }, subs {TenDonViCap2, members{id }, subs {TenDonViCap3, members{id }, subs{TenDonViCap4, members{id } } } } } }"),s&&r.push('group(user:"'+t+'"){id,name,member,creater}'),P(N+"/graphql","{"+r.join()+"}",void 0,function(t){c(t.data)})},H=A(D),K=A(k),B=[],F=[],L=$("<div id='chatapp' class='chat-app'></div>"),X=function(t,e){return this.box=t,this.membertemp=[],this.state=e||{show:!0,full:!0,online:!1,new:0,title:""},this.box_head=$('<div class="live-hd"><div class="pull-left visitor-name">'+this.box.title+'</div><div class="pull-right"><a href="javascript:void(0)"><i class="fa fa-cog"></i></a><a href="javascript:void(0)" class="btnclose-min"><i class="fa fa-chevron-down"></i><i class="fa fa-chevron-up"></i></a><a href="javascript:void(0)"><i class="fa fa-remove"></i></a></div><div class="clearfix"></div></div>'),this.box_content_top=$('<div class="live-ct-top"><a href="javascript:void(0)"><i class="fa fa-dashboard fa-lg"></i></a><a href="javascript:void(0)"><i class="fa fa-info fa-lg"></i></a></div>'),this.box_content_search=$('<div class="live-search"><i class="fa fa-search"></i><input type="text" placeholder="T&igrave;m ki&#7871;m"></div>'),this.box_content_input=$('<div class="live-chat-ft"><div class="textarea"><textarea placeholder="Nh&#7853;p n&#7897;i dung"></textarea></div><button class="btn btn-submit">G&#7917;i</button><a href="" class="btn btn-attach" title="&#272;&iacute;nh k&egrave;m file"><i class="fa fa-paperclip"></i></a></div>'),this.box_content=$('<div class="live-ct"></div>'),this.box_content_chat=$('<div class="live-chat"></div>'),this.box_group_add_user=$('<div class="content-adduser"><a href="javascript:void(0)" class="btn-creategroup"><i class="fa fa-check fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-refresh"><i class="fa fa-refresh fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-cancel"><i class="fa fa-close fa-lg ga"></i></a><a href="javascript:void(0)" class="btn-add"><i class="fa fa-group fa-lg"></i></a><div class="content"><div class="select-box"><select class="js-multiple" data-placeholder="Th&ecirc;m th&agrave;nh vi&ecirc;n..." multiple tabindex="3"></select></div></div></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.search_btnRefresh={},this.messages=[],this.dates=[],this.setState=function(t){var e=this;e.state=_.assign(e.state,t),e.dom.removeClass("hidden"),0==e.state.show&&e.dom.addClass("hidden"),e.box_content.removeClass("in"),e.box_head.find(".btnclose-min").removeClass("open"),e.state.full&&(e.box_content.addClass("in"),e.box_head.find(".btnclose-min").addClass("open")),e.box_head.find(".online").remove(),e.state.online&&e.box_head.prepend('<span class="online pull-left"></span>')},this.displayMessage=function(t,e){var a=this;t.idtemp&&console.log(t),t.time=t.time||new Date-O;var n=E(t.time),i=_.findIndex(a.dates,function(e){return U(e.date,t.time)});if(i==-1){var o=$('<time class="text-right">'+n+"</time>");!_.last(a.dates)||t.time>_.last(a.dates).date?(a.box_content_chat.append(o),a.dates.push({date:t.time,dom:o})):(a.box_content_chat.prepend(o),a.dates.splice(0,0,{date:t.time,dom:o}))}t.dom||(t.dom=$('<div class="line_message"><div class="content_message">'+t.content+"</div></div>"),t.dom.dblclick(function(){alert(new Date(t.time))}));var s=_.findIndex(a.messages,function(e){return e.time>t.time});if(s==-1){if(_.last(a.messages)&&_.last(a.messages).from==t.from&&i!==-1)_.last(a.messages).dom.after(t.dom);else if(t.from==j.id){var c=$('<div class="'+g+'"></div>');c.append(t.dom),a.box_content_chat.append(c)}else{var c=$('<div class="'+x+'"><div class="avatar"><img src="'+(H[t.from].avatar||r)+'"></div> </div>');c.append(t.dom),a.box_content_chat.append(c)}a.messages.push(t)}else{if(a.messages[s].from===t.from&&i!==-1)a.messages[s].dom.before(t.dom);else if(t.from==j.id){var c=$('<div class="'+g+'"></div>');c.append(t.dom),a.dates[0].dom.after(c)}else{var c=$('<div class="'+x+'"><div class="avatar"><img src="'+(H[t.from].avatar||r)+'"></div> </div>');c.append(t.dom),a.dates[0].dom.after(c)}a.messages.splice(s,0,t)}e&&a.box_content_chat.scrollTop(1e10)},this.scrollMessage=function(t){},this.createMessage=function(t){var e=this;return"group"==e.box.type?{idtemp:M(8),from:j.id,toGroup:e.box.id,content:t}:{idtemp:M(8),from:j.id,toUser:e.box.id,content:t}},this.loadMessage=function(t){var e=this,a=void 0,n={time:-1};if(t){var i=_.first(e.messages)?_.first(e.messages).time:void 0;a={$lt:i}}if("group"==e.box.type){var o={query:{toGroup:e.box.id},page:0,limit:w};a&&(o.query.time=a),o.sort=n;var s="id, content, time, state, from, toGroup";P(N+"/graphql",'{message(q:"'+JSON.stringify(o).replace(/"/g,'\\"')+'"){'+s+"}}",{},function(a){var n=a.data.message||[];n.forEach(function(a){a.time=parseInt(a.time);var n=!t;e.displayMessage(a,n)})})}else{var o={query:{$or:[{toUser:j.id,from:e.box.id},{toUser:e.box.id,from:j.id}]},page:0,limit:w};a&&(o.query.time=a),o.sort=n;var s="id, content, time, state, from, toUser";P(N+"/graphql",'{message(q:"'+JSON.stringify(o).replace(/"/g,'\\"')+'"){'+s+"}}",void 0,function(a){var n=a.data.message||[];n.forEach(function(a){a.time=parseInt(a.time);var n=!t;e.displayMessage(a,n)})})}},this.updateBox=function(t){var e=this;e.box=_.clone(t),e.box_head.find(".visitor-name").html(e.box.title),"group"===t.type&&e.search_btnRefresh.click()},this.init=function(){var t=this;if(t.wrap.append(t.box_head),t.box_content.append(t.box_content_top),t.box_content.append(t.box_content_chat),t.box_content.append(t.box_content_search),t.box_content.append(t.box_content_input),"group"===t.box.type){var e=t.box_group_add_user.find(".js-multiple"),a=t.box_head.find(".visitor-name");t.membertemp=_.clone(t.box.member),a.dblclick(function(){$(this).attr("contenteditable",!0);var e=$(this).html();$(this).addClass("edit-title"),$(this).keydown(function(a){13==a.which&&(a.preventDefault(),""!==$(this).html().trim()?(V({id:t.box.id,title:$(this).html().trim()},m,function(t){console.log(t),z(b,t)}),$(this).attr("contenteditable","false"),$(this).removeClass("edit-title")):($(this).html(e),$(this).attr("contenteditable","false"),$(this).removeClass("edit-title")))}),$(this).focus()}),_.forEach(H,function(a,n){var i="";t.box.member.indexOf(a.id)!==-1&&(i='selected="true"'),e.append('<option value="'+a.id+'" '+i+">"+a.nickName+"</option>")}),e.chosen({disable_search_threshold:10,allow_single_deselect:!0,no_results_text:"Kh&ocirc;ng ph&ugrave; h&#7907;p!",width:"100%"}),e.chosen().change(function(e,a){a.selected&&t.membertemp.push(a.selected),a.deselected&&_.pull(t.membertemp,a.deselected)});var o=t.box_group_add_user.find(".btn-add"),s=t.box_group_add_user.find(".content"),c=t.box_group_add_user.find(".btn-cancel"),r=t.box_group_add_user.find(".btn-creategroup");t.search_btnRefresh=t.box_group_add_user.find(".btn-refresh"),o.click(function(){s.addClass("view-adduser"),t.box_content_top.find(".ga").fadeIn(1e3).css("display","inline-block")}),c.click(function(){s.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3),t.membertemp=_.clone(t.box.member),e.find("option").each(function(){$(this).removeAttr("selected"),t.box.member.indexOf($(this).val())!==-1&&$(this).prop("selected",!0)}),e.trigger("chosen:updated")}),r.click(function(){t.membertemp.length==t.box.member.length&&0==_.difference(t.membertemp,t.box.member).length&&(s.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3)),V({id:t.box.id,member:t.membertemp},m,function(e){s.removeClass("view-adduser"),t.box_content_top.find(".ga").fadeOut(1e3),z(b,e)})}),t.search_btnRefresh.click(function(){t.membertemp=_.clone(t.box.member),e.find("option").each(function(){$(this).removeAttr("selected"),t.box.member.indexOf($(this).val())!==-1&&$(this).prop("selected",!0)}),e.trigger("chosen:updated")});var d=$('<a href="javascript:void(0)"><i class="fa fa-sign-out fa-lg"></i></a>');d.click(function(){}),t.box_content_top.append(d),t.box_content_top.append(t.box_group_add_user)}t.wrap.append(t.box_content),t.dom.append(t.wrap),t.setState(),t.box_content_chat.scroll(function(){0===$(this).scrollTop()&&t.loadMessage(!0)});var l=t.box_head.find("a.btnclose-min");l.on("click",function(){t.state.full=0==t.state.full,t.setState(),z(i)});var p=t.box_head.find("a .fa-remove");p.on("click",function(e){t.state.show=!1,t.setState(),z(i)});var h=t.box_content_input.find("textarea");t.box_content_input.find("button");return h.keydown(function(e){if(13==e.keyCode&&e.shiftKey){var a=$(this).val();return $(this).val(a+"\n"),void e.stopPropagation()}if(13==e.which&&(e.preventDefault(),""!==$(this).val())){var i=t.createMessage($(this).val());z(n,i),$(this).val(""),console.log(i),t.displayMessage(i,!0)}}),h.focus(function(){}),t.loadMessage(),t},this.init()},Y=function(t,e){return this.state=t||{tab:0,full:!1},this.title=e,this.contactDom={},this.onlineDom={},this.contact_head=$('<div class="live-hd"><div class="pull-left visitor-name">'+this.title+'</div><div class="pull-right"><a href="javascript:void(0)" class="btn-addgroup"><i class="fa fa-plus"></i></a><a href="javascript:void(0)" class="btnclose-min"><i class="fa fa-chevron-down"></i><i class="fa fa-chevron-up"></i></a></div><div class="clearfix"></div></div>'),this.contact_content=$('<div class="live-ct"></div>'),this.contact_tab_nav=$('<ul class="nav nav-tabs"><li><a data-toggle="tab" href="#tab-online">Online</a></li><li><a data-toggle="tab" href="#tab-phancap">Ph&acirc;n c&#7845;p</a></li><li><a data-toggle="tab" href="#tab-nhom">Nh&oacute;m</a></li></ul>'),this.contact_tab_content=$('<div class="tab-content"></div>'),this.contact_tab_online=$('<div id="tab-online" class="tab-pane fade"></div>'),this.contact_tab_recently=$('<div id="tab-recently" class="tab-pane fade"></div>'),this.contact_tab_phancap=$('<div id="tab-phancap" class="tab-pane fade"></div>'),this.contact_tab_friend=$('<div id="tab-friend" class="tab-pane fade"></div>'),this.contact_tab_nhom=$('<div id="tab-nhom" class="tab-pane fade"></div>'),this.tab=[this.contact_tab_online,this.contact_tab_phancap,this.contact_tab_nhom],this.contact_content_search=$('<div class="live-search"><i class="fa fa-search"></i><input type="text" placeholder="T&igrave;m ki&#7871;m"></div>'),this.wrap=$('<div class="chat-box"></div>'),this.dom=$('<div class="chat-div"></div>'),this.setState=function(t){var e=this;e.state=_.assign(e.state,t),e.contact_content.removeClass("in"),e.contact_head.find(".btnclose-min").removeClass("open"),e.state.full&&(e.contact_content.addClass("in"),e.contact_head.find(".btnclose-min").addClass("open")),e.contact_tab_nav.find("li").eq(e.state.tab).click(),e.contact_tab_nav.find("li").eq(e.state.tab).hasClass("active")||(e.contact_tab_nav.find("li").eq(e.state.tab).addClass("active"),e.tab[e.state.tab].removeClass("fade").addClass("active"))},this.getState=function(){var t=this;return t.state},this.contactor=function(t,e){var a=this,n=H[t];if(n&&t!=j.id){var i=n.avatar&&""!=n.avatar?n.avatar:r,s=$('<div class="'+x+'"><div class="avatar"><img src="'+i+'"></div><div class="status"><span class="'+n.state+'">'+I(n.last)+'</span></div><div class="supporter"><div class="name">'+n.nickName+'</div><div class="text">'+n.status||"</div></div></div>");return s.click(function(){z(o,{type:"user",id:t,title:n.nickName})}),e?(a.onlineDom[t]=s,s):(a.contactDom[t]||(a.contactDom[t]=[]),a.contactDom[t].push(s),s)}},this.groupDom=function(t){var e=this,a=e.panelCollapor(t.name,t.id);return t.member.forEach(function(t){var n=e.contactor(t);a.panelContent.append(n)}),a.panel.dblclick(function(){z(o,{type:"group",id:t.id,title:t.name,member:t.member})}),a.panel},this.panelCollapor=function(t,e){var a=e||M(19),n=$('<div class="panel panel-default guid-blok"><div class="panel-heading"><a class="collapsed" data-toggle="collapse" data-parent="#expan" href="#'+a+'" aria-expanded="true" aria-controls="collapseOne"><span></span><strong>'+t+"</strong></a></div></div>"),i=$('<div id="'+a+'" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne" aria-expanded="true"></div>');return n.append(i),{panel:n,panelContent:i}},this.updateContactor=function(t,e){e.find(".avatar img").attr("src",H[t].avatar),e.find(".status span").remove(),e.find(".status").append('<span class="'+H[t].state+'">'+I(H[t].last)+"</span>"),e.find(".supporter .name").html(H[t].nickName),e.find(".supporter .text").html(H[t].status)},this.updateContact=function(t){var e=this;e&&e.contactDom[t]&&(e.contactDom[t].forEach(function(a){e.updateContactor(t,a)}),H[t].state==T?e.onlineDom[t]||e.contact_tab_online.find(".live-chat.list.contact-chat").prepend(e.contactor(t)):e.onlineDom[t]&&e.onlineDom[t].remove())},this.loadRecently=function(t){var e=this,a=$('<div class="live-chat list contact-chat">');e.contact_tab_recently.find(".live-chat").remove(),e.contact_tab_recently.append(a)},this.loadFriend=function(t){var e=this,a=$('<div class="live-chat list contact-chat">');e.contact_tab_friend.find(".live-chat").remove(),e.contact_tab_friend.append(a)},this.loadOnline=function(t){var e=this;e.contact_tab_online.append('<div class="live-chat list contact-chat">'),t&&_(t).forEach(function(t){H[t].state=T,e.updateContact(t)})},this.loadNhom=function(t){var e=this,a=$('<div class="live-chat chat-group contact-chat"></div>');t&&t.forEach(function(t){var n=e.groupDom(t);a.append(n)}),e.contact_tab_nhom.find(".live-chat").remove(),e.contact_tab_nhom.append(a)},this.loadPhanCap=function(t,e){var a=this;if(!e){var n=a.panelCollapor(t.TenDonViCap1||t.TenDonViCap2||t.TenDonViCap3||t.TenDonViCap4,t.id||M(19));return t.subs&&t.subs.forEach(function(t){n.panelContent.append(a.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var e=t.id,i=a.contactor(e);n.panelContent.append(i)}),n}var n=$('<div class="live-chat chat-group contact-chat"></div>');t.subs&&t.subs.forEach(function(t){n.append(a.loadPhanCap(t).panel)}),t.members&&t.members.forEach(function(t){var e=t.id,i=a.contactor(e);n.append(i)}),a.contact_tab_phancap.find(".live-chat").remove(),a.contact_tab_phancap.append(n)},this.init=function(){var t=this;_(t.tab).forEach(function(e){t.contact_tab_content.append(e)}),t.contact_content.append(t.contact_tab_nav),t.contact_content.append(t.contact_tab_content),t.contact_content.append(t.contact_content_search),t.wrap.append(t.contact_head),t.wrap.append(t.contact_content),t.dom.append(t.wrap),t.setState();var e=t.contact_head.find("a.btnclose-min");e.click(function(){t.state.full=0==t.state.full,t.setState(),z(s,t.state)}),t.contact_tab_nav.find("li").click(function(){t.state.tab=$(this).index(),z(s,t.state)});var a=t.contact_head.find(".btn-addgroup");return a.click(function(){z(c)}),t.loadPhanCap(K,!0),t.loadNhom(F),t.loadOnline(B),t},this.init()},z=function(t,a){if(t===o){Z=Z||{},Z[a.id]||(Z[a.id]=new X(a,{show:!0,full:!0}),L.append(Z[a.id].dom)),at(a.id,!0)}if(t===c&&V({creater:j.id},v,function(t){var t=a.data.updateGroup,e={id:t.id,title:t.name,type:"group",member:t.member};Z[t.id]=new X(e,{show:!0,full:!0}),L.append(Z[a.id].dom),at(t.id,!0)}),t===b){var r=!0;_.forEach(F,function(t){t.id===a.id&&(t=_.clone(a),r=!1)}),r&&F.push(a),tt.loadNhom(F),console.log(F,a),Z[a.id]&&Z[a.id].updateBox({id:a.id,type:"group",title:a.name,member:a.member}),at()}t===s&&(Q=_.assign(Q,{state:a}),R(S,Q)),t===n&&e.emit(d,a),t===i&&at()},Q=A(S),W=A(C),Z={},tt={},et=function(t){Z=Z||{},t.from===j.id?(t.toUser&&(Z[t.toUser]?Z[t.toUser].displayMessage(t):(Z[t.toUser]=new X({id:t.toUser,type:"user"},{show:!1,full:!0}),L.append(Z[t.toUser].dom),at(t.toUser,!1))),t.toGroup&&(Z[t.toGroup]?Z[t.toGroup].displayMessage(t):(Z[t.toGroup]=new X({id:t.toGroup,type:"group"},{show:!1,full:!0}),L.append(Z[t.toGroup].dom),at(t.toGroup,!1)))):t.toUser&&t.toUser==j.id?Z[t.from]?Z[t.from].displayMessage(t):(Z[t.from]=new X({id:t.from,type:"user"},{show:!1,full:!0}),L.append(Z[t.from].dom),at(t.from,!1)):Z[t.toGroup]?Z[t.toGroup].displayMessage(t):(Z[t.toGroup]=new X({id:t.toGroup,type:"group"},{show:!1,full:!0}),L.append(Z[t.toGroup].dom),at(t.toGroup,!1))},at=function(t,e){var a=e?1:0;Q={time:(new Date).getTime(),item:[],state:tt.getState()};for(var n in Z){var i=Z[n].state.show;i&&2==a&&(i=!1),i&&a++,t&&e&&n==t&&(i=!0);var o={show:i,online:B.indexOf(t)!==-1};Z[n].setState(o),Z[n].state.show&&Q.item.push(_.assign(Z[n].box,{state:Z[n].state}))}t&&a<2&&(Z[t].setState({show:!0}),Q.item.push(_.assign(Z[t].box,{state:Z[t].state}))),R(S,Q)},nt=function(){e.on(h,function(t,e){t!=W&&(H={},R(C,t)),O=new Date-e}),e.on(f,function(t){H[t].state=G,tt.updateContact(t),Z[t]&&Z[t].setState({online:!1})}),e.on(u,function(t){H[t].state=T,tt.updateContact(t),Z[t]&&Z[t].setState({online:!0})}),e.on(l,function(t){et(t)}),e.emit(p,j)};return this.dom=L,this.init=function(){var t=this,e=A(y),a={full:!1,tab:0};return e&&e.userId==j.userId?(j=e,Q&&Q.state&&(a=Q.state),J(j.userId,void 0,"online",void 0,void 0,void 0,"group",function(t){B=t.online,F=t.group,tt=new Y(a,j.nickName),L.append(tt.dom),Q&&new Date-Q.time<9e6?Q.item.forEach(function(t){Z[t.id]=new X(t,t.state),L.append(Z[t.id].dom)}):(Q={time:(new Date).getTime(),item:[],state:{full:!1,tab:0}},R(S,Q)),nt()})):J(j.userId,"contacts","online","recently","phancap","friend","group",function(t){j=_.assign(j,t.user),R(y,j),H={},t.users.forEach(function(t){H[t.id]=t}),R(D,H),B=t.online,K=t.phancap.phancap||{},R(k,K),F=t.group,console.log(F),tt=new Y(a,H[j.id].nickName),L.append(tt.dom),Q={time:(new Date).getTime(),item:[],state:{full:!1,tab:0}},R(S,Q),nt()}),$(window).unload(function(){at()}),t},this.init()};